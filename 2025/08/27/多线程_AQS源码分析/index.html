<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>多线程_AQS源码分析 | Joie's Blog</title><meta name="keywords" content="多线程,并发"><meta name="author" content="Joie"><meta name="copyright" content="Joie"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="多线程_AQS源码分析"><meta name="application-name" content="多线程_AQS源码分析"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="多线程_AQS源码分析"><meta property="og:url" content="http://example.com/2025/08/27/%E5%A4%9A%E7%BA%BF%E7%A8%8B_AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html"><meta property="og:site_name" content="Joie's Blog"><meta property="og:description" content="AQS源码深度分析目录 1. ReentrantLock数据结构与继承关系 2. AQS核心机制 3. 加锁流程详解 4. 解锁流程详解 5. 公平锁vs非公平锁 6. 相关面试题   1. ReentrantLock数据结构与继承关系1.1 整体架构ReentrantLock 内部核心实现主要靠三"><meta property="og:locale" content="en"><meta property="og:image" content="https://origin.picgo.net/2025/08/29/aqs-letter-logo-design-on-black-background-aqs-creative-initials-letter-logo-concept-aqs-letter-design-vector23c92936b0e2ac9c.jpg"><meta property="article:author" content="Joie"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://origin.picgo.net/2025/08/29/aqs-letter-logo-design-on-black-background-aqs-creative-initials-letter-logo-concept-aqs-letter-design-vector23c92936b0e2ac9c.jpg"><meta name="description" content="AQS源码深度分析目录 1. ReentrantLock数据结构与继承关系 2. AQS核心机制 3. 加锁流程详解 4. 解锁流程详解 5. 公平锁vs非公平锁 6. 相关面试题   1. ReentrantLock数据结构与继承关系1.1 整体架构ReentrantLock 内部核心实现主要靠三"><link rel="shortcut icon" href="/favicon.ico"><link rel="canonical" href="http://example.com/2025/08/27/%E5%A4%9A%E7%BA%BF%E7%A8%8B_AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"AnZhiYu","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: {"enable":true,"leaveTitle":"Here","backTitle":"Welcome"},
  LA51: undefined,
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: '',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: {"mode":"api","api":"https://img2color-go.vercel.app/api?img=","cover_change":true},
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","🏠 智能家居小能手","🔨 设计开发一条龙","🤝 专修交互与设计","🏃 脚踏实地行动派","🧱 团队小组发动机","💢 壮汉人狠话不多"]},
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"Author: Joie","link":"Link: ","source":"Source: Joie's Blog","info":"Copyright is owned by the author. For commercial reprints, please contact the author for authorization. For non-commercial reprints, please indicate the source.","copySuccess":"Copy success, copy and reprint please mark the address of this article"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'Joie\'s Blog',
  title: '多线程_AQS源码分析',
  postAI: '',
  pageFillDescription: 'AQS源码深度分析, 目录, 1. ReentrantLock数据结构与继承关系, 1.1 整体架构, 1.2 继承关系图, 1.3 核心内部类详解, 1.3.1 Sync（抽象基类）, 1.3.2 NonfairSync（非公平锁实现）, 1.3.3 FairSync（公平锁实现）, 2. AQS核心机制, 2.1 AQS核心字段, 2.2 AQS核心方法分类, 2.2.1 独占模式（Exclusive）, 2.2.2 共享模式（Shared）, 2.2.3 队列管理（核心机制）, 2.3 核心调用链总结, 3. 加锁流程详解, 3.1 完整加锁流程, 3.1.1 最外层入口：lock(), 3.1.2 快速尝试：initialTryLock(), 3.1.3 慢路径：acquire(int arg), 3.1.4 核心获取流程：acquire(...), 3.2 加锁流程图, 4. 解锁流程详解, 4.1 完整解锁流程, 4.1.1 ReentrantLock.unlock(), 4.1.2 AQS.release(int arg), 4.1.3 tryRelease(arg) （ReentrantLock 的实现）, 4.1.4 唤醒后继线程：unparkSuccessor(Node h), 4.2 解锁流程图, 5. 公平锁vs非公平锁, 5.1 对比总结, 5.2 核心差异代码, 5.3 选择建议, 6. 相关面试题, 6.1 AQS核心原理, 6.2 ReentrantLock实现原理, 6.3 公平锁vs非公平锁, 6.4 AQS队列机制, 6.5 锁的性能优化, 6.6 死锁预防, 6.7 源码设计模式, 6.8 实际应用场景, 总结源码深度分析目录数据结构与继承关系核心机制加锁流程详解解锁流程详解公平锁非公平锁相关面试题数据结构与继承关系整体架构内部核心实现主要靠三个内部类来支撑核心思想只是一个壳子真正的加锁解锁逻辑都委托给了体系继承关系图非公平锁实现公平锁实现核心内部类详解抽象基类核心字段锁状态空闲被占用持有锁的线程核心方法关键特点继承了表示锁的重入次数没人持有被某个线程持有值为重入次数记录持有锁的线程提供了模板具体由子类公平非公平实现获取逻辑非公平锁实现尝试直接抢锁没抢到进入队列排队主要特点插队机制线程调用时先尝试用抢锁如果成功直接获得锁不管队列里是否有人在等如果失败才会走的队列挂起逻辑优点吞吐量高减少线程切换缺点可能导致饥饿一直有新线程插队队列里的老线程迟迟拿不到锁公平锁实现直接交给的公平获取逻辑主要特点严格排队每次获取锁时先判断队列里是否有前驱节点如果有人在排队必须排队不能插队只有队列前面没人或者自己在队首才能尝试抢锁就是公平的关键判断是否有线程在前面排队优点线程获取锁的顺序和请求顺序一致避免饥饿缺点吞吐量比非公平锁低核心机制核心字段核心状态字段同步状态队列头尾指针持有锁的线程继承自核心数据结构表示同步状态如锁是否被占用重入次数信号量数量等队列一个双向队列用来挂起等待的线程节点核心方法分类独占模式用于互斥锁如方法作用实现方独占模式入口方法实现真正尝试获取锁子类实现独占模式释放方法实现真正释放锁子类实现共享模式用于允许多个线程同时获取的资源如方法作用实现方共享模式入口实现共享资源获取逻辑子类实现释放共享资源实现释放共享资源逻辑子类实现队列管理核心机制方法作用把当前线程封装成节点加入队列自旋尝试获取锁如果失败则阻塞唤醒队列中的下一个等待线程判断当前线程是否有前驱节点公平锁依赖核心调用链总结独占模式为例失败入队阻塞唤醒队列下一个共享模式为例失败入队阻塞唤醒下一个加锁流程详解完整加锁流程最外层入口逻辑先快速尝试抢一下如果失败走完整的队列排队获取快速尝试表示锁的占用次数没人占锁重入逻辑分析锁空闲如果队列没人等把改成抢到锁且是自己支持重入否则返回抢锁失败这个方法对应乐观快速路径大部分时候锁竞争不激烈它就直接成功了慢路径逻辑再尝试一次获取锁如果还失败进入即入队自旋挂起核心获取流程这是最复杂的地方核心循环逻辑判断是否在队列首如果在首或者未入队再尝试获取锁获取不到入队入队后如果还是拿不到锁设置等待状态加锁流程图成功返回失败成功返回循环判断是否队首在队首成功指向自己不在队首入队入队后设置阻塞被唤醒回到解锁流程详解完整解锁流程调用的是的参数代表释放一个资源一次重入唤醒队列中的下一个等待者逻辑真正释放锁子类实现如果完全释放成功归零尝试唤醒队列里的下一个线程返回表示锁已经空闲的实现归零锁彻底释放逻辑分析减少重入计数如果锁完全释放清空持有线程记录返回否则只是部分释放比如重入次释放一次从变返回唤醒后继线程逻辑先把节点的状态清零找到第一个有效的后继节点等待状态的节点调用唤醒它解锁流程图清空锁彻底释放找到的下一个等待线程唤醒它公平锁非公平锁对比总结特性非公平锁公平锁获取策略插队机制直接抢锁严格排队性能吞吐量高吞吐量较低公平性可能导致饥饿保证公平性实现复杂度简单复杂默认选择是否核心差异代码非公平锁直接抢锁公平锁直接交给的公平获取逻辑关键检查是否有前驱选择建议高并发场景选择非公平锁性能更好需要严格顺序选择公平锁避免饥饿一般情况默认非公平锁即可相关面试题核心原理的核心原理是什么是并发包中的核心同步器其核心原理包括状态管理通过字段管理同步状态队列机制使用队列双向链表管理等待线程模板方法模式提供模板子类实现独占共享模式支持独占锁如和共享锁如核心思想通过操作管理状态通过队列管理等待线程实现高效的线程同步实现原理是如何实现可重入的通过以下机制实现可重入计数每次获取锁时释放时记录记录持有锁的线程重入判断在中检查当前线程是否为计数管理重入时递增完全释放时归零重入逻辑递增公平锁非公平锁公平锁和非公平锁的区别是什么主要区别如下获取策略非公平锁直接抢锁可能插队公平锁检查队列严格性能差异非公平锁吞吐量高减少线程切换公平锁吞吐量低保证公平性饥饿问题非公平锁可能导致饥饿公平锁避免饥饿实现复杂度非公平锁实现简单公平锁需要检查队列机制的队列是如何工作的队列工作机制节点结构每个等待线程封装为节点入队操作通过操作将节点添加到队尾出队操作获取锁的线程成为新的节点唤醒机制释放锁时唤醒下一个等待节点状态管理通过管理节点状态核心流程线程获取锁失败创建节点入队阻塞被唤醒重新尝试获取锁锁的性能优化在性能方面做了哪些优化主要优化包括快速路径直接避免入队开销自旋等待在前进行短暂自旋减少上下文切换操作使用保证原子性避免重量级锁队列优化队列减少锁竞争提高并发性能状态压缩将多个状态信息压缩到字段中死锁预防如何避免使用时的死锁避免死锁的策略固定顺序按固定顺序获取多个锁超时机制使用避免无限等待锁的粒度尽量减小锁的粒度减少持有时间避免嵌套避免在持有锁时获取其他锁使用工具使用等更细粒度的锁源码设计模式使用了哪些设计模式主要使用了以下设计模式模板方法模式提供模板由子类实现策略模式通过不同的实现类提供不同的锁策略状态模式通过字段管理不同的同步状态观察者模式通过队列管理等待线程实现线程间的通知机制实际应用场景在实际项目中什么时候选择而不是选择的场景需要公平性需要保证线程获取锁的顺序需要超时使用避免无限等待需要中断使用响应中断需要多个条件变量使用实现复杂的等待通知需要可重入同一个线程需要多次获取锁性能要求高在高并发场景下性能更好总结作为并发包的核心通过巧妙的设计实现了高效的线程同步机制状态管理通过字段管理同步状态队列机制使用队列管理等待线程模板方法提供统一的同步框架性能优化快速路径自旋等待等优化策略作为的典型应用展示了如何基于构建可重入的独占锁通过公平锁和非公平锁的不同实现满足了不同场景的需求掌握的核心原理不仅有助于理解并发包的设计思想也为解决实际并发问题提供了重要的理论基础',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-08-29 17:16:04',
  postMainColor: '#5393E3',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://img.picgo.net/2025/06/23/tom09183405464859c2.jpg"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">个人主页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://benedicttom.github.io/home/" title="个人主页"><img class="back-menu-item-icon" src="/img/favicon.ico" alt="个人主页"/><span class="back-menu-item-text">个人主页</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">Joie's Blog</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/equipment/"><i class="anzhiyufont anzhiyu-icon-dice-d20 faa-tada" style="font-size: 0.9em;"></i><span> 我的装备</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-weichat.png"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/qrcode-alipay.png"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> Newest Comments</span></div><div class="aside-list"><span>loading...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AI/" style="font-size: 1.05rem;">AI<sup>1</sup></a><a href="/tags/AMQP/" style="font-size: 1.05rem;">AMQP<sup>1</sup></a><a href="/tags/CI-CD/" style="font-size: 1.05rem;">CI/CD<sup>1</sup></a><a href="/tags/ElasticSearch/" style="font-size: 1.05rem;">ElasticSearch<sup>3</sup></a><a href="/tags/Hexo/" style="font-size: 1.05rem;">Hexo<sup>1</sup></a><a href="/tags/Http/" style="font-size: 1.05rem;">Http<sup>2</sup></a><a href="/tags/I-O/" style="font-size: 1.05rem;">I/O<sup>2</sup></a><a href="/tags/Java/" style="font-size: 1.05rem;">Java<sup>10</sup></a><a href="/tags/MongoDB/" style="font-size: 1.05rem;">MongoDB<sup>1</sup></a><a href="/tags/Mysql/" style="font-size: 1.05rem;">Mysql<sup>2</sup></a><a href="/tags/ORM/" style="font-size: 1.05rem;">ORM<sup>3</sup></a><a href="/tags/Python/" style="font-size: 1.05rem;">Python<sup>5</sup></a><a href="/tags/Redis/" style="font-size: 1.05rem;">Redis<sup>7</sup></a><a href="/tags/Redisson/" style="font-size: 1.05rem;">Redisson<sup>1</sup></a><a href="/tags/Rpc/" style="font-size: 1.05rem;">Rpc<sup>2</sup></a><a href="/tags/Spring/" style="font-size: 1.05rem;">Spring<sup>3</sup></a><a href="/tags/Spring-Cloud/" style="font-size: 1.05rem;">Spring Cloud<sup>5</sup></a><a href="/tags/Spring-Data/" style="font-size: 1.05rem;">Spring Data<sup>5</sup></a><a href="/tags/Swagger/" style="font-size: 1.05rem;">Swagger<sup>1</sup></a><a href="/tags/%E4%B8%9A%E5%8A%A1/" style="font-size: 1.05rem;">业务<sup>1</sup></a><a href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/" style="font-size: 1.05rem;">云原生<sup>1</sup></a><a href="/tags/%E5%85%AB%E8%82%A1/" style="font-size: 1.05rem;">八股<sup>1</sup></a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" style="font-size: 1.05rem;">分布式锁<sup>1</sup></a><a href="/tags/%E5%8A%9B%E6%89%A3/" style="font-size: 1.05rem;">力扣<sup>10</sup></a><a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 1.05rem;">多线程<sup>9</sup></a><a href="/tags/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/" style="font-size: 1.05rem;">定时任务<sup>3</sup></a><a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 1.05rem;">并发<sup>10</sup></a><a href="/tags/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" style="font-size: 1.05rem;">开发工具<sup>2</sup></a><a href="/tags/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/" style="font-size: 1.05rem;">异步编程<sup>1</sup></a><a href="/tags/%E6%8E%A8%E8%8D%90/" style="font-size: 1.05rem;">推荐<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 1.05rem;">数据结构<sup>1</sup></a><a href="/tags/%E6%9D%83%E9%99%90%E6%A0%A1%E9%AA%8C/" style="font-size: 1.05rem;">权限校验<sup>4</sup></a><a href="/tags/%E6%9E%B6%E6%9E%84/" style="font-size: 1.05rem;">架构<sup>1</sup></a><a href="/tags/%E6%A0%91/" style="font-size: 1.05rem;">树<sup>1</sup></a><a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 1.05rem;">消息队列<sup>5</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 1.05rem;">算法<sup>2</sup></a><a href="/tags/%E7%BC%93%E5%AD%98/" style="font-size: 1.05rem;">缓存<sup>3</sup></a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 1.05rem;">设计模式<sup>1</sup></a><a href="/tags/%E8%BF%90%E7%BB%B4/" style="font-size: 1.05rem;">运维<sup>2</sup></a><a href="/tags/%E9%9B%86%E5%90%88/" style="font-size: 1.05rem;">集合<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>Archives</span></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/10/"><span class="card-archive-list-date">October 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">2</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/09/"><span class="card-archive-list-date">September 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">9</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/08/"><span class="card-archive-list-date">August 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">46</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">July 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">28</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">June 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">8</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%B9%B6%E5%8F%91/" itemprop="url">并发</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>多线程</span></a><a class="article-meta__tags" href="/tags/%E5%B9%B6%E5%8F%91/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>并发</span></a></span></div></div><h1 class="post-title" itemprop="name headline">多线程_AQS源码分析</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2025-08-27T02:08:43.170Z" title="Created 2025-08-27 10:08:43">2025-08-27</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-08-29T09:16:04.528Z" title="Updated 2025-08-29 17:16:04">2025-08-29</time></span></div><div class="meta-secondline"><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为北京"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>北京</span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://origin.picgo.net/2025/08/29/aqs-letter-logo-design-on-black-background-aqs-creative-initials-letter-logo-concept-aqs-letter-design-vector23c92936b0e2ac9c.jpg"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="http://example.com/2025/08/27/%E5%A4%9A%E7%BA%BF%E7%A8%8B_AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><header><a class="post-meta-categories" href="/categories/%E5%B9%B6%E5%8F%91/" itemprop="url">并发</a><a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" tabindex="-1" itemprop="url">多线程</a><a href="/tags/%E5%B9%B6%E5%8F%91/" tabindex="-1" itemprop="url">并发</a><h1 id="CrawlerTitle" itemprop="name headline">多线程_AQS源码分析</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">Joie</span><time itemprop="dateCreated datePublished" datetime="2025-08-27T02:08:43.170Z" title="Created 2025-08-27 10:08:43">2025-08-27</time><time itemprop="dateCreated datePublished" datetime="2025-08-29T09:16:04.528Z" title="Updated 2025-08-29 17:16:04">2025-08-29</time></header><h1 id="AQS源码深度分析"><a href="#AQS源码深度分析" class="headerlink" title="AQS源码深度分析"></a>AQS源码深度分析</h1><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#1-reentrantlock%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB">1. ReentrantLock数据结构与继承关系</a></li>
<li><a href="#2-aqs%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6">2. AQS核心机制</a></li>
<li><a href="#3-%E5%8A%A0%E9%94%81%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3">3. 加锁流程详解</a></li>
<li><a href="#4-%E8%A7%A3%E9%94%81%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3">4. 解锁流程详解</a></li>
<li><a href="#5-%E5%85%AC%E5%B9%B3%E9%94%81vs%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%81">5. 公平锁vs非公平锁</a></li>
<li><a href="#6-%E7%9B%B8%E5%85%B3%E9%9D%A2%E8%AF%95%E9%A2%98">6. 相关面试题</a></li>
</ul>
<hr>
<h2 id="1-ReentrantLock数据结构与继承关系"><a href="#1-ReentrantLock数据结构与继承关系" class="headerlink" title="1. ReentrantLock数据结构与继承关系"></a>1. ReentrantLock数据结构与继承关系</h2><h3 id="1-1-整体架构"><a href="#1-1-整体架构" class="headerlink" title="1.1 整体架构"></a>1.1 整体架构</h3><p><code>ReentrantLock</code> 内部核心实现主要靠三个内部类来支撑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReentrantLock</span> <span class="keyword">implements</span> <span class="title class_">Lock</span>, java.io.Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Sync sync;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Sync</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span> &#123; ... &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonfairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123; ... &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">FairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>核心思想</strong>：<code>ReentrantLock</code> 只是一个壳子，真正的加锁&#x2F;解锁逻辑都委托给了 <code>Sync</code> 体系。</p>
<h3 id="1-2-继承关系图"><a href="#1-2-继承关系图" class="headerlink" title="1.2 继承关系图"></a>1.2 继承关系图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ReentrantLock</span><br><span class="line">    └── Sync (abstract) extends AbstractQueuedSynchronizer</span><br><span class="line">        ├── NonfairSync (非公平锁实现)</span><br><span class="line">        └── FairSync (公平锁实现)</span><br></pre></td></tr></table></figure>

<h3 id="1-3-核心内部类详解"><a href="#1-3-核心内部类详解" class="headerlink" title="1.3 核心内部类详解"></a>1.3 核心内部类详解</h3><h4 id="1-3-1-Sync（抽象基类）"><a href="#1-3-1-Sync（抽象基类）" class="headerlink" title="1.3.1 Sync（抽象基类）"></a>1.3.1 Sync（抽象基类）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Sync</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span> &#123;</span><br><span class="line">    <span class="comment">// 核心字段</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> state;        <span class="comment">// 锁状态：0=空闲，&gt;0=被占用</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Thread exclusiveOwnerThread; <span class="comment">// 持有锁的线程</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 核心方法</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">nonfairTryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> releases)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>关键特点</strong>：</p>
<ul>
<li>继承了 <strong>AQS (AbstractQueuedSynchronizer)</strong></li>
<li><strong>state</strong> 表示锁的重入次数（0 &#x3D; 没人持有，&gt;0 &#x3D; 被某个线程持有，值为重入次数）</li>
<li><strong>exclusiveOwnerThread</strong> 记录持有锁的线程</li>
<li>提供了 <strong>acquire&#x2F;release</strong> 模板，具体由子类（公平&#x2F;非公平）实现获取逻辑</li>
</ul>
<h4 id="1-3-2-NonfairSync（非公平锁实现）"><a href="#1-3-2-NonfairSync（非公平锁实现）" class="headerlink" title="1.3.2 NonfairSync（非公平锁实现）"></a>1.3.2 NonfairSync（非公平锁实现）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NonfairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))   <span class="comment">// 尝试直接抢锁</span></span><br><span class="line">            setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            acquire(<span class="number">1</span>);  <span class="comment">// 没抢到，进入AQS队列排队</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nonfairTryAcquire(acquires);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>主要特点</strong>：<strong>插队机制</strong></p>
<ul>
<li>线程调用 <code>lock()</code> 时，先尝试用 <code>compareAndSetState(0, 1)</code> 抢锁（CAS）</li>
<li>如果成功，直接获得锁 → 不管队列里是否有人在等</li>
<li>如果失败，才会走 AQS 的队列挂起逻辑</li>
</ul>
<p><strong>优点</strong>：吞吐量高，减少线程切换<br><strong>缺点</strong>：可能导致<strong>饥饿</strong>（一直有新线程插队，队列里的老线程迟迟拿不到锁）</p>
<h4 id="1-3-3-FairSync（公平锁实现）"><a href="#1-3-3-FairSync（公平锁实现）" class="headerlink" title="1.3.3 FairSync（公平锁实现）"></a>1.3.3 FairSync（公平锁实现）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">FairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        acquire(<span class="number">1</span>); <span class="comment">// 直接交给AQS的公平获取逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp; compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(current);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">            setState(c + acquires);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>主要特点</strong>：<strong>严格排队</strong></p>
<ul>
<li>每次获取锁时，先判断队列里是否有前驱节点</li>
<li>如果有人在排队 → 必须排队，不能插队</li>
<li>只有队列前面没人或者自己在队首，才能尝试 <code>CAS</code> 抢锁</li>
<li><code>hasQueuedPredecessors()</code> 就是公平的关键 → 判断是否有线程在前面排队</li>
</ul>
<p><strong>优点</strong>：线程获取锁的顺序和请求顺序一致，<strong>避免饥饿</strong><br><strong>缺点</strong>：吞吐量比非公平锁低</p>
<hr>
<h2 id="2-AQS核心机制"><a href="#2-AQS核心机制" class="headerlink" title="2. AQS核心机制"></a>2. AQS核心机制</h2><h3 id="2-1-AQS核心字段"><a href="#2-1-AQS核心字段" class="headerlink" title="2.1 AQS核心字段"></a>2.1 AQS核心字段</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractQueuedSynchronizer</span> <span class="keyword">extends</span> <span class="title class_">AbstractOwnableSynchronizer</span> &#123;</span><br><span class="line">    <span class="comment">// 核心状态字段</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> state;        <span class="comment">// 同步状态</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// CLH队列头尾指针</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node head;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node tail;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 持有锁的线程（继承自AbstractOwnableSynchronizer）</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Thread exclusiveOwnerThread;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>核心数据结构</strong>：</p>
<ul>
<li><strong>state</strong>（int）：表示同步状态（如锁是否被占用，重入次数，信号量数量等）</li>
<li><strong>CLH 队列</strong>：一个 FIFO 双向队列，用来挂起等待的线程（<code>head</code>、<code>tail</code> 节点）</li>
</ul>
<h3 id="2-2-AQS核心方法分类"><a href="#2-2-AQS核心方法分类" class="headerlink" title="2.2 AQS核心方法分类"></a>2.2 AQS核心方法分类</h3><h4 id="2-2-1-独占模式（Exclusive）"><a href="#2-2-1-独占模式（Exclusive）" class="headerlink" title="2.2.1 独占模式（Exclusive）"></a>2.2.1 独占模式（Exclusive）</h4><p>👉 用于 <strong>互斥锁</strong>（如 ReentrantLock）</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>作用</th>
<th>实现方</th>
</tr>
</thead>
<tbody><tr>
<td><code>acquire(int arg)</code></td>
<td>独占模式入口方法</td>
<td>AQS实现</td>
</tr>
<tr>
<td><code>tryAcquire(int arg)</code></td>
<td>真正尝试获取锁</td>
<td>子类实现</td>
</tr>
<tr>
<td><code>release(int arg)</code></td>
<td>独占模式释放方法</td>
<td>AQS实现</td>
</tr>
<tr>
<td><code>tryRelease(int arg)</code></td>
<td>真正释放锁</td>
<td>子类实现</td>
</tr>
</tbody></table>
<h4 id="2-2-2-共享模式（Shared）"><a href="#2-2-2-共享模式（Shared）" class="headerlink" title="2.2.2 共享模式（Shared）"></a>2.2.2 共享模式（Shared）</h4><p>👉 用于 <strong>允许多个线程同时获取的资源</strong>（如 Semaphore、CountDownLatch）</p>
<table>
<thead>
<tr>
<th>方法</th>
<th>作用</th>
<th>实现方</th>
</tr>
</thead>
<tbody><tr>
<td><code>acquireShared(int arg)</code></td>
<td>共享模式入口</td>
<td>AQS实现</td>
</tr>
<tr>
<td><code>tryAcquireShared(int arg)</code></td>
<td>共享资源获取逻辑</td>
<td>子类实现</td>
</tr>
<tr>
<td><code>releaseShared(int arg)</code></td>
<td>释放共享资源</td>
<td>AQS实现</td>
</tr>
<tr>
<td><code>tryReleaseShared(int arg)</code></td>
<td>释放共享资源逻辑</td>
<td>子类实现</td>
</tr>
</tbody></table>
<h4 id="2-2-3-队列管理（核心机制）"><a href="#2-2-3-队列管理（核心机制）" class="headerlink" title="2.2.3 队列管理（核心机制）"></a>2.2.3 队列管理（核心机制）</h4><table>
<thead>
<tr>
<th>方法</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>addWaiter(Node mode)</code></td>
<td>把当前线程封装成节点，加入队列</td>
</tr>
<tr>
<td><code>acquireQueued(Node node, int arg)</code></td>
<td>自旋尝试获取锁，如果失败则阻塞</td>
</tr>
<tr>
<td><code>unparkSuccessor(Node node)</code></td>
<td>唤醒队列中的下一个等待线程</td>
</tr>
<tr>
<td><code>hasQueuedPredecessors()</code></td>
<td>判断当前线程是否有前驱节点（公平锁依赖）</td>
</tr>
</tbody></table>
<h3 id="2-3-核心调用链总结"><a href="#2-3-核心调用链总结" class="headerlink" title="2.3 核心调用链总结"></a>2.3 核心调用链总结</h3><p><strong>独占模式（ReentrantLock 为例）</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">lock() </span><br><span class="line">  -&gt; sync.lock()</span><br><span class="line">    -&gt; acquire(1) </span><br><span class="line">      -&gt; tryAcquire(1) 失败 → addWaiter() 入队 → acquireQueued() 阻塞</span><br><span class="line">unlock()</span><br><span class="line">  -&gt; sync.release(1) </span><br><span class="line">    -&gt; tryRelease(1) → unparkSuccessor() 唤醒队列下一个</span><br></pre></td></tr></table></figure>

<p><strong>共享模式（Semaphore 为例）</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">acquire()</span><br><span class="line">  -&gt; acquireShared(1)</span><br><span class="line">    -&gt; tryAcquireShared(1) 失败 → addWaiter(SHARED) 入队 → doAcquireShared() 阻塞</span><br><span class="line">release()</span><br><span class="line">  -&gt; releaseShared(1)</span><br><span class="line">    -&gt; tryReleaseShared(1) → doReleaseShared() 唤醒下一个</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-加锁流程详解"><a href="#3-加锁流程详解" class="headerlink" title="3. 加锁流程详解"></a>3. 加锁流程详解</h2><h3 id="3-1-完整加锁流程"><a href="#3-1-完整加锁流程" class="headerlink" title="3.1 完整加锁流程"></a>3.1 完整加锁流程</h3><h4 id="3-1-1-最外层入口：lock"><a href="#3-1-1-最外层入口：lock" class="headerlink" title="3.1.1 最外层入口：lock()"></a>3.1.1 最外层入口：<code>lock()</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ReservedStackAccess</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!initialTryLock())</span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>逻辑</strong>：</p>
<ul>
<li><strong>先快速尝试</strong> <code>initialTryLock()</code>（CAS 抢一下）</li>
<li>如果失败，走 <strong>完整的 AQS 队列排队获取</strong> <code>acquire(1)</code></li>
</ul>
<h4 id="3-1-2-快速尝试：initialTryLock"><a href="#3-1-2-快速尝试：initialTryLock" class="headerlink" title="3.1.2 快速尝试：initialTryLock()"></a>3.1.2 快速尝试：<code>initialTryLock()</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">initialTryLock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState(); <span class="comment">// state 表示锁的占用次数</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123; <span class="comment">// 没人占锁</span></span><br><span class="line">        <span class="keyword">if</span> (!hasQueuedThreads() &amp;&amp; compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (getExclusiveOwnerThread() == current) &#123; <span class="comment">// 重入</span></span><br><span class="line">        <span class="keyword">if</span> (++c &lt; <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        setState(c);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>逻辑分析</strong>：</p>
<ul>
<li><code>state == 0</code> → 锁空闲 → 如果队列没人等 → CAS 把 <code>state</code> 改成 1 → 抢到锁</li>
<li><code>state &gt; 0 且 owner 是自己</code> → 支持重入（<code>state++</code>）</li>
<li>否则返回 <code>false</code> → 抢锁失败</li>
</ul>
<p>⚡ 这个方法对应 <strong>乐观快速路径</strong>，大部分时候锁竞争不激烈，它就直接成功了</p>
<h4 id="3-1-3-慢路径：acquire-int-arg"><a href="#3-1-3-慢路径：acquire-int-arg" class="headerlink" title="3.1.3 慢路径：acquire(int arg)"></a>3.1.3 慢路径：<code>acquire(int arg)</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg))</span><br><span class="line">        acquire(<span class="literal">null</span>, arg, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="number">0L</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>逻辑</strong>：</p>
<ul>
<li><code>tryAcquire(arg)</code>：再尝试一次获取锁</li>
<li>如果还失败 → 进入 <code>acquire(...)</code>，即 <strong>入队、自旋、挂起</strong></li>
</ul>
<h4 id="3-1-4-核心获取流程：acquire"><a href="#3-1-4-核心获取流程：acquire" class="headerlink" title="3.1.4 核心获取流程：acquire(...)"></a>3.1.4 核心获取流程：<code>acquire(...)</code></h4><p>这是 AQS 最复杂的地方，核心循环逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="title function_">acquire</span><span class="params">(Node node, <span class="type">int</span> arg, <span class="type">boolean</span> shared,</span></span><br><span class="line"><span class="params">                  <span class="type">boolean</span> interruptible, <span class="type">boolean</span> timed, <span class="type">long</span> time)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">byte</span> <span class="variable">spins</span> <span class="operator">=</span> <span class="number">0</span>, postSpins = <span class="number">0</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>, first = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">Node</span> <span class="variable">pred</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// Step1: 判断是否在队列首</span></span><br><span class="line">        <span class="keyword">if</span> (!first &amp;&amp; (pred = (node == <span class="literal">null</span>) ? <span class="literal">null</span> : node.prev) != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">            !(first = (head == pred))) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pred.status &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                cleanQueue();           <span class="comment">// predecessor cancelled</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pred.prev == <span class="literal">null</span>) &#123;</span><br><span class="line">                Thread.onSpinWait();    <span class="comment">// ensure serialization</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Step2: 如果在首（或者未入队），再尝试获取锁</span></span><br><span class="line">        <span class="keyword">if</span> (first || pred == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">boolean</span> acquired;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (shared)</span><br><span class="line">                    acquired = (tryAcquireShared(arg) &gt;= <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    acquired = tryAcquire(arg);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                cancelAcquire(node, interrupted, <span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">throw</span> ex;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (acquired) &#123;</span><br><span class="line">                <span class="keyword">if</span> (first) &#123;</span><br><span class="line">                    node.prev = <span class="literal">null</span>;</span><br><span class="line">                    head = node;</span><br><span class="line">                    pred.next = <span class="literal">null</span>;</span><br><span class="line">                    node.waiter = <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (shared)</span><br><span class="line">                        signalNextIfShared(node);</span><br><span class="line">                    <span class="keyword">if</span> (interrupted)</span><br><span class="line">                        current.interrupt();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Step3: 获取不到 → 入队（enq）</span></span><br><span class="line">        <span class="keyword">if</span> (node == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (shared)</span><br><span class="line">                node = <span class="keyword">new</span> <span class="title class_">SharedNode</span>();</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                node = <span class="keyword">new</span> <span class="title class_">ExclusiveNode</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pred == <span class="literal">null</span>) &#123;</span><br><span class="line">            node.waiter = current;</span><br><span class="line">            <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail;</span><br><span class="line">            node.setPrevRelaxed(t);</span><br><span class="line">            <span class="keyword">if</span> (t == <span class="literal">null</span>)</span><br><span class="line">                tryInitializeHead();</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!casTail(t, node))</span><br><span class="line">                node.setPrevRelaxed(<span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                t.next = node;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Step4: 入队后，如果还是拿不到锁 → 设置等待状态 / park</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (first &amp;&amp; spins != <span class="number">0</span>) &#123;</span><br><span class="line">            --spins;</span><br><span class="line">            Thread.onSpinWait();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.status == <span class="number">0</span>) &#123;</span><br><span class="line">            node.status = WAITING;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">long</span> nanos;</span><br><span class="line">            spins = postSpins = (<span class="type">byte</span>)((postSpins &lt;&lt; <span class="number">1</span>) | <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (!timed)</span><br><span class="line">                LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((nanos = time - System.nanoTime()) &gt; <span class="number">0L</span>)</span><br><span class="line">                LockSupport.parkNanos(<span class="built_in">this</span>, nanos);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            node.clearStatus();</span><br><span class="line">            <span class="keyword">if</span> ((interrupted |= Thread.interrupted()) &amp;&amp; interruptible)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cancelAcquire(node, interrupted, interruptible);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-2-加锁流程图"><a href="#3-2-加锁流程图" class="headerlink" title="3.2 加锁流程图"></a>3.2 加锁流程图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">lock()</span><br><span class="line">  └─&gt; initialTryLock() → 成功 → 返回</span><br><span class="line">                      → 失败 → acquire(1)</span><br><span class="line">                                   ├─ tryAcquire(1) → 成功 → 返回</span><br><span class="line">                                   └─ acquire(...) 循环</span><br><span class="line">                                            ├─ 判断是否队首</span><br><span class="line">                                            ├─ 在队首 → tryAcquire → 成功 → head 指向自己</span><br><span class="line">                                            ├─ 不在队首 → 入队</span><br><span class="line">                                            ├─ 入队后 → 设置 WAITING → park 阻塞</span><br><span class="line">                                            └─ 被 unpark 唤醒 → 回到 tryAcquire</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-解锁流程详解"><a href="#4-解锁流程详解" class="headerlink" title="4. 解锁流程详解"></a>4. 解锁流程详解</h2><h3 id="4-1-完整解锁流程"><a href="#4-1-完整解锁流程" class="headerlink" title="4.1 完整解锁流程"></a>4.1 完整解锁流程</h3><h4 id="4-1-1-ReentrantLock-unlock"><a href="#4-1-1-ReentrantLock-unlock" class="headerlink" title="4.1.1 ReentrantLock.unlock()"></a>4.1.1 ReentrantLock.unlock()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    sync.release(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用的是 AQS 的 <code>release(1)</code>，参数 <code>1</code> 代表「释放一个资源（一次重入）」</p>
<h4 id="4-1-2-AQS-release-int-arg"><a href="#4-1-2-AQS-release-int-arg" class="headerlink" title="4.1.2 AQS.release(int arg)"></a>4.1.2 AQS.release(int arg)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">release</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h.status != <span class="number">0</span>)</span><br><span class="line">            unparkSuccessor(h);  <span class="comment">// 唤醒队列中的下一个等待者</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>逻辑</strong>：</p>
<ul>
<li><strong><code>tryRelease(arg)</code></strong>：真正释放锁（子类实现）</li>
<li>如果完全释放成功（state 归零） → 尝试唤醒队列里的下一个线程</li>
<li>返回 <code>true</code> 表示锁已经空闲</li>
</ul>
<h4 id="4-1-3-tryRelease-arg-（ReentrantLock-的实现）"><a href="#4-1-3-tryRelease-arg-（ReentrantLock-的实现）" class="headerlink" title="4.1.3 tryRelease(arg) （ReentrantLock 的实现）"></a>4.1.3 tryRelease(arg) （ReentrantLock 的实现）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState() - releases;</span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">free</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;   <span class="comment">// state 归零，锁彻底释放</span></span><br><span class="line">        free = <span class="literal">true</span>;</span><br><span class="line">        setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    setState(c);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>逻辑分析</strong>：</p>
<ul>
<li><code>state - releases</code>：减少重入计数</li>
<li>如果 <code>state == 0</code>：<ul>
<li>锁完全释放</li>
<li>清空持有线程记录（exclusiveOwnerThread &#x3D; null）</li>
<li>返回 <code>true</code></li>
</ul>
</li>
<li>否则只是部分释放（比如重入 3 次，释放一次 → state 从 3 变 2），返回 <code>false</code></li>
</ul>
<h4 id="4-1-4-唤醒后继线程：unparkSuccessor-Node-h"><a href="#4-1-4-唤醒后继线程：unparkSuccessor-Node-h" class="headerlink" title="4.1.4 唤醒后继线程：unparkSuccessor(Node h)"></a>4.1.4 唤醒后继线程：unparkSuccessor(Node h)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unparkSuccessor</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> node.status;</span><br><span class="line">    <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)</span><br><span class="line">        compareAndSetWaitStatus(node, ws, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">null</span> || s.status &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        s = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail; t != <span class="literal">null</span> &amp;&amp; t != node; t = t.prev) &#123;</span><br><span class="line">            <span class="keyword">if</span> (t.status &lt;= <span class="number">0</span>)</span><br><span class="line">                s = t;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="literal">null</span>)</span><br><span class="line">        LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>逻辑</strong>：</p>
<ul>
<li>先把 <strong>head 节点的状态</strong> 清零</li>
<li>找到第一个有效的后继节点（等待状态的节点）</li>
<li>调用 <code>LockSupport.unpark(s.thread)</code> 唤醒它</li>
</ul>
<h3 id="4-2-解锁流程图"><a href="#4-2-解锁流程图" class="headerlink" title="4.2 解锁流程图"></a>4.2 解锁流程图</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">unlock()</span><br><span class="line">  → release(1)</span><br><span class="line">       → tryRelease(1)</span><br><span class="line">            state -= 1</span><br><span class="line">            if state == 0:</span><br><span class="line">               清空 owner</span><br><span class="line">               return true</span><br><span class="line">            else:</span><br><span class="line">               return false</span><br><span class="line">       → if true (锁彻底释放)</span><br><span class="line">            unparkSuccessor(head)</span><br><span class="line">                找到 head 的下一个等待线程</span><br><span class="line">                LockSupport.unpark() 唤醒它</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="5-公平锁vs非公平锁"><a href="#5-公平锁vs非公平锁" class="headerlink" title="5. 公平锁vs非公平锁"></a>5. 公平锁vs非公平锁</h2><h3 id="5-1-对比总结"><a href="#5-1-对比总结" class="headerlink" title="5.1 对比总结"></a>5.1 对比总结</h3><table>
<thead>
<tr>
<th>特性</th>
<th>非公平锁（NonfairSync）</th>
<th>公平锁（FairSync）</th>
</tr>
</thead>
<tbody><tr>
<td><strong>获取策略</strong></td>
<td>插队机制，直接CAS抢锁</td>
<td>严格FIFO排队</td>
</tr>
<tr>
<td><strong>性能</strong></td>
<td>吞吐量高</td>
<td>吞吐量较低</td>
</tr>
<tr>
<td><strong>公平性</strong></td>
<td>可能导致饥饿</td>
<td>保证公平性</td>
</tr>
<tr>
<td><strong>实现复杂度</strong></td>
<td>简单</td>
<td>复杂</td>
</tr>
<tr>
<td><strong>默认选择</strong></td>
<td>是</td>
<td>否</td>
</tr>
</tbody></table>
<h3 id="5-2-核心差异代码"><a href="#5-2-核心差异代码" class="headerlink" title="5.2 核心差异代码"></a>5.2 核心差异代码</h3><p><strong>非公平锁</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))   <span class="comment">// 直接抢锁</span></span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>公平锁</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    acquire(<span class="number">1</span>); <span class="comment">// 直接交给AQS的公平获取逻辑</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="comment">// 关键：hasQueuedPredecessors() 检查是否有前驱</span></span><br><span class="line">    <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp; compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-3-选择建议"><a href="#5-3-选择建议" class="headerlink" title="5.3 选择建议"></a>5.3 选择建议</h3><ul>
<li><strong>高并发场景</strong>：选择非公平锁，性能更好</li>
<li><strong>需要严格顺序</strong>：选择公平锁，避免饥饿</li>
<li><strong>一般情况</strong>：默认非公平锁即可</li>
</ul>
<hr>
<h2 id="6-相关面试题"><a href="#6-相关面试题" class="headerlink" title="6. 相关面试题"></a>6. 相关面试题</h2><h3 id="6-1-AQS核心原理"><a href="#6-1-AQS核心原理" class="headerlink" title="6.1 AQS核心原理"></a>6.1 AQS核心原理</h3><p><strong>Q: AQS的核心原理是什么？</strong></p>
<p><strong>A:</strong> AQS（AbstractQueuedSynchronizer）是Java并发包中的核心同步器，其核心原理包括：</p>
<ol>
<li><strong>状态管理</strong>：通过volatile int state字段管理同步状态</li>
<li><strong>队列机制</strong>：使用CLH队列（FIFO双向链表）管理等待线程</li>
<li><strong>模板方法模式</strong>：提供acquire&#x2F;release模板，子类实现tryAcquire&#x2F;tryRelease</li>
<li><strong>独占&#x2F;共享模式</strong>：支持独占锁（如ReentrantLock）和共享锁（如Semaphore）</li>
</ol>
<p><strong>核心思想</strong>：通过CAS操作管理state状态，通过队列管理等待线程，实现高效的线程同步。</p>
<h3 id="6-2-ReentrantLock实现原理"><a href="#6-2-ReentrantLock实现原理" class="headerlink" title="6.2 ReentrantLock实现原理"></a>6.2 ReentrantLock实现原理</h3><p><strong>Q: ReentrantLock是如何实现可重入的？</strong></p>
<p><strong>A:</strong> ReentrantLock通过以下机制实现可重入：</p>
<ol>
<li><strong>state计数</strong>：每次获取锁时state+1，释放时state-1</li>
<li><strong>owner记录</strong>：exclusiveOwnerThread记录持有锁的线程</li>
<li><strong>重入判断</strong>：在tryAcquire中检查当前线程是否为owner</li>
<li><strong>计数管理</strong>：重入时state递增，完全释放时state归零</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 重入逻辑</span></span><br><span class="line"><span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">    setState(c + acquires);  <span class="comment">// state递增</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-3-公平锁vs非公平锁"><a href="#6-3-公平锁vs非公平锁" class="headerlink" title="6.3 公平锁vs非公平锁"></a>6.3 公平锁vs非公平锁</h3><p><strong>Q: 公平锁和非公平锁的区别是什么？</strong></p>
<p><strong>A:</strong> 主要区别如下：</p>
<ol>
<li><p><strong>获取策略</strong>：</p>
<ul>
<li>非公平锁：直接CAS抢锁，可能插队</li>
<li>公平锁：检查队列，严格FIFO</li>
</ul>
</li>
<li><p><strong>性能差异</strong>：</p>
<ul>
<li>非公平锁：吞吐量高，减少线程切换</li>
<li>公平锁：吞吐量低，保证公平性</li>
</ul>
</li>
<li><p><strong>饥饿问题</strong>：</p>
<ul>
<li>非公平锁：可能导致饥饿</li>
<li>公平锁：避免饥饿</li>
</ul>
</li>
<li><p><strong>实现复杂度</strong>：</p>
<ul>
<li>非公平锁：实现简单</li>
<li>公平锁：需要hasQueuedPredecessors()检查</li>
</ul>
</li>
</ol>
<h3 id="6-4-AQS队列机制"><a href="#6-4-AQS队列机制" class="headerlink" title="6.4 AQS队列机制"></a>6.4 AQS队列机制</h3><p><strong>Q: AQS的CLH队列是如何工作的？</strong></p>
<p><strong>A:</strong> CLH队列工作机制：</p>
<ol>
<li><strong>节点结构</strong>：每个等待线程封装为Node节点</li>
<li><strong>入队操作</strong>：通过CAS操作将节点添加到队尾</li>
<li><strong>出队操作</strong>：获取锁的线程成为新的head节点</li>
<li><strong>唤醒机制</strong>：释放锁时唤醒下一个等待节点</li>
<li><strong>状态管理</strong>：通过Node.status管理节点状态</li>
</ol>
<p><strong>核心流程</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">线程获取锁失败 → 创建Node节点 → CAS入队 → park阻塞 → 被唤醒 → 重新尝试获取锁</span><br></pre></td></tr></table></figure>

<h3 id="6-5-锁的性能优化"><a href="#6-5-锁的性能优化" class="headerlink" title="6.5 锁的性能优化"></a>6.5 锁的性能优化</h3><p><strong>Q: AQS在性能方面做了哪些优化？</strong></p>
<p><strong>A:</strong> 主要优化包括：</p>
<ol>
<li><strong>快速路径</strong>：initialTryLock()直接CAS，避免入队开销</li>
<li><strong>自旋等待</strong>：在park前进行短暂自旋，减少上下文切换</li>
<li><strong>CAS操作</strong>：使用CAS保证原子性，避免重量级锁</li>
<li><strong>队列优化</strong>：CLH队列减少锁竞争，提高并发性能</li>
<li><strong>状态压缩</strong>：将多个状态信息压缩到state字段中</li>
</ol>
<h3 id="6-6-死锁预防"><a href="#6-6-死锁预防" class="headerlink" title="6.6 死锁预防"></a>6.6 死锁预防</h3><p><strong>Q: 如何避免使用ReentrantLock时的死锁？</strong></p>
<p><strong>A:</strong> 避免死锁的策略：</p>
<ol>
<li><strong>固定顺序</strong>：按固定顺序获取多个锁</li>
<li><strong>超时机制</strong>：使用tryLock(timeout)避免无限等待</li>
<li><strong>锁的粒度</strong>：尽量减小锁的粒度，减少持有时间</li>
<li><strong>避免嵌套</strong>：避免在持有锁时获取其他锁</li>
<li><strong>使用工具</strong>：使用ReentrantReadWriteLock等更细粒度的锁</li>
</ol>
<h3 id="6-7-源码设计模式"><a href="#6-7-源码设计模式" class="headerlink" title="6.7 源码设计模式"></a>6.7 源码设计模式</h3><p><strong>Q: AQS使用了哪些设计模式？</strong></p>
<p><strong>A:</strong> 主要使用了以下设计模式：</p>
<ol>
<li><strong>模板方法模式</strong>：acquire&#x2F;release提供模板，tryAcquire&#x2F;tryRelease由子类实现</li>
<li><strong>策略模式</strong>：通过不同的Sync实现类提供不同的锁策略</li>
<li><strong>状态模式</strong>：通过state字段管理不同的同步状态</li>
<li><strong>观察者模式</strong>：通过队列管理等待线程，实现线程间的通知机制</li>
</ol>
<h3 id="6-8-实际应用场景"><a href="#6-8-实际应用场景" class="headerlink" title="6.8 实际应用场景"></a>6.8 实际应用场景</h3><p><strong>Q: 在实际项目中，什么时候选择ReentrantLock而不是synchronized？</strong></p>
<p><strong>A:</strong> 选择ReentrantLock的场景：</p>
<ol>
<li><strong>需要公平性</strong>：需要保证线程获取锁的顺序</li>
<li><strong>需要超时</strong>：使用tryLock(timeout)避免无限等待</li>
<li><strong>需要中断</strong>：使用lockInterruptibly()响应中断</li>
<li><strong>需要多个条件变量</strong>：使用Condition实现复杂的等待&#x2F;通知</li>
<li><strong>需要可重入</strong>：同一个线程需要多次获取锁</li>
<li><strong>性能要求高</strong>：在高并发场景下性能更好</li>
</ol>
<hr>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>AQS作为Java并发包的核心，通过巧妙的设计实现了高效的线程同步机制：</p>
<ol>
<li><strong>状态管理</strong>：通过volatile state字段管理同步状态</li>
<li><strong>队列机制</strong>：使用CLH队列管理等待线程</li>
<li><strong>模板方法</strong>：提供统一的同步框架</li>
<li><strong>性能优化</strong>：快速路径、自旋等待等优化策略</li>
</ol>
<p>ReentrantLock作为AQS的典型应用，展示了如何基于AQS构建可重入的独占锁，通过公平锁和非公平锁的不同实现，满足了不同场景的需求。</p>
<p>掌握AQS的核心原理，不仅有助于理解Java并发包的设计思想，也为解决实际并发问题提供了重要的理论基础。</p>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.picgo.net/2025/06/23/tom09183405464859c2.jpg" title="头像" alt="头像"><img class="post-copyright__author_img_front" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.picgo.net/2025/06/23/tom09183405464859c2.jpg" title="头像" alt="头像"></a><div class="post-copyright__author_name">Joie</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="http://example.com/2025/08/27/%E5%A4%9A%E7%BA%BF%E7%A8%8B_AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('http://example.com/2025/08/27/%E5%A4%9A%E7%BA%BF%E7%A8%8B_AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/')">多线程_AQS源码分析</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="http://example.com/2025/08/27/%E5%A4%9A%E7%BA%BF%E7%A8%8B_AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=多线程_AQS源码分析&amp;url=http://example.com/2025/08/27/%E5%A4%9A%E7%BA%BF%E7%A8%8B_AQS%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/&amp;pic=https://origin.picgo.net/2025/08/29/aqs-letter-logo-design-on-black-background-aqs-creative-initials-letter-logo-concept-aqs-letter-design-vector23c92936b0e2ac9c.jpg" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>多线程<span class="tagsPageCount">9</span></a><a class="post-meta__box__tags" href="/tags/%E5%B9%B6%E5%8F%91/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>并发<span class="tagsPageCount">10</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://origin.picgo.net/2025/10/23/1739c9e15974460f19.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2025/08/25/Redis_Redission/"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://origin.picgo.net/2025/08/07/1eb94f064cf74b04865bdaf1b3c8e9be6939674b9205c975.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Redisson全面指南</div></div></a></div><div class="next-post pull-right"><a href="/2025/08/29/%E5%88%86%E5%B1%82%E5%AF%BC%E5%85%A5_BFS%E5%BA%94%E7%94%A8/"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://origin.picgo.net/2025/08/29/bfsd5599ff4a1cc3b7f.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">分层导入：BFS 在分层导入中的实践</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2025/07/14/%E5%A4%9A%E7%BA%BF%E7%A8%8B_CompletableFuture/" title="多线程_CompletableFuture"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.picgo.net/2025/07/14/e16bbae9e8c14ccea5dbca7108afb50f2ce119221e21affb.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-07-14</div><div class="title">多线程_CompletableFuture</div></div></a></div><div><a href="/2025/07/14/%E5%A4%9A%E7%BA%BF%E7%A8%8B_Threadlocal/" title="多线程_Threadlocal"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://javaguide.cn/assets/1-YS5yhxvD.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-07-14</div><div class="title">多线程_Threadlocal</div></div></a></div><div><a href="/2025/07/10/%E5%A4%9A%E7%BA%BF%E7%A8%8B_%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%9E%8B/" title="多线程_共享模型"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.picgo.net/2025/07/14/jmm706db083f71abac3.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-07-10</div><div class="title">多线程_共享模型</div></div></a></div><div><a href="/2025/07/11/%E5%A4%9A%E7%BA%BF%E7%A8%8B_%E6%97%A0%E9%94%81%E5%B9%B6%E5%8F%91/" title="多线程_无锁并发"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.picgo.net/2025/07/14/97bc61de389a4e3aa6b605bf4df3a3296c4fffa8a9280cb3.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-07-11</div><div class="title">多线程_无锁并发</div></div></a></div><div><a href="/2025/07/07/%E5%A4%9A%E7%BA%BF%E7%A8%8B_%E7%BA%BF%E7%A8%8B%E6%B1%A0/" title="多线程_线程池"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.picgo.net/2025/07/07/6c4064c88ff621702204e7fe46a464266ce0015884687e07.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-07-07</div><div class="title">多线程_线程池</div></div></a></div><div><a href="/2025/07/04/%E5%A4%9A%E7%BA%BF%E7%A8%8B_%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/" title="多线程基础知识"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.picgo.net/2025/07/04/d024edf10a2542f19a69f198fac4a202e6b996209c5c57bc.png" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2025-07-04</div><div class="title">多线程基础知识</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-content"><div class="author-info__sayhi" id="author-info__sayhi" onclick="anzhiyu.changeSayHelloText()"></div><div class="author-info-avatar"><img class="avatar-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://img.picgo.net/2025/06/23/tom09183405464859c2.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__description"><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">这有关于<b style="color:#fff">产品、设计、开发</b>相关的问题和看法，还有<b style="color:#fff">文章翻译</b>和<b style="color:#fff">分享</b>。</div><div style="line-height:1.38;margin:0.6rem 0;text-align:justify;color:rgba(255, 255, 255, 0.8);">相信你可以在这里找到对你有用的<b style="color:#fff">知识</b>和<b style="color:#fff">教程</b>。</div></div><div class="author-info__bottom-group"><a class="author-info__bottom-group-left" href="/"><h1 class="author-info__name">Joie</h1><div class="author-info__desc"></div></a><div class="card-info-social-icons is-center"><a class="social-icon faa-parent animated-hover" href="https://github.com/BenedictTom" target="_blank" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="social-icon faa-parent animated-hover" href="https://space.bilibili.com/372204786" target="_blank" title="BiliBili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a></div></div></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#AQS%E6%BA%90%E7%A0%81%E6%B7%B1%E5%BA%A6%E5%88%86%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">AQS源码深度分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95"><span class="toc-number">1.1.</span> <span class="toc-text">目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-ReentrantLock%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB"><span class="toc-number">1.2.</span> <span class="toc-text">1. ReentrantLock数据结构与继承关系</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.1 整体架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB%E5%9B%BE"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.2 继承关系图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E6%A0%B8%E5%BF%83%E5%86%85%E9%83%A8%E7%B1%BB%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.2.3.</span> <span class="toc-text">1.3 核心内部类详解</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-1-Sync%EF%BC%88%E6%8A%BD%E8%B1%A1%E5%9F%BA%E7%B1%BB%EF%BC%89"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">1.3.1 Sync（抽象基类）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-2-NonfairSync%EF%BC%88%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%81%E5%AE%9E%E7%8E%B0%EF%BC%89"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">1.3.2 NonfairSync（非公平锁实现）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-3-FairSync%EF%BC%88%E5%85%AC%E5%B9%B3%E9%94%81%E5%AE%9E%E7%8E%B0%EF%BC%89"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">1.3.3 FairSync（公平锁实现）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-AQS%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6"><span class="toc-number">1.3.</span> <span class="toc-text">2. AQS核心机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-AQS%E6%A0%B8%E5%BF%83%E5%AD%97%E6%AE%B5"><span class="toc-number">1.3.1.</span> <span class="toc-text">2.1 AQS核心字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-AQS%E6%A0%B8%E5%BF%83%E6%96%B9%E6%B3%95%E5%88%86%E7%B1%BB"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.2 AQS核心方法分类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-1-%E7%8B%AC%E5%8D%A0%E6%A8%A1%E5%BC%8F%EF%BC%88Exclusive%EF%BC%89"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">2.2.1 独占模式（Exclusive）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-2-%E5%85%B1%E4%BA%AB%E6%A8%A1%E5%BC%8F%EF%BC%88Shared%EF%BC%89"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">2.2.2 共享模式（Shared）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-3-%E9%98%9F%E5%88%97%E7%AE%A1%E7%90%86%EF%BC%88%E6%A0%B8%E5%BF%83%E6%9C%BA%E5%88%B6%EF%BC%89"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">2.2.3 队列管理（核心机制）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E6%A0%B8%E5%BF%83%E8%B0%83%E7%94%A8%E9%93%BE%E6%80%BB%E7%BB%93"><span class="toc-number">1.3.3.</span> <span class="toc-text">2.3 核心调用链总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E5%8A%A0%E9%94%81%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.4.</span> <span class="toc-text">3. 加锁流程详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%AE%8C%E6%95%B4%E5%8A%A0%E9%94%81%E6%B5%81%E7%A8%8B"><span class="toc-number">1.4.1.</span> <span class="toc-text">3.1 完整加锁流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-1-%E6%9C%80%E5%A4%96%E5%B1%82%E5%85%A5%E5%8F%A3%EF%BC%9Alock"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">3.1.1 最外层入口：lock()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-2-%E5%BF%AB%E9%80%9F%E5%B0%9D%E8%AF%95%EF%BC%9AinitialTryLock"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">3.1.2 快速尝试：initialTryLock()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-3-%E6%85%A2%E8%B7%AF%E5%BE%84%EF%BC%9Aacquire-int-arg"><span class="toc-number">1.4.1.3.</span> <span class="toc-text">3.1.3 慢路径：acquire(int arg)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-4-%E6%A0%B8%E5%BF%83%E8%8E%B7%E5%8F%96%E6%B5%81%E7%A8%8B%EF%BC%9Aacquire"><span class="toc-number">1.4.1.4.</span> <span class="toc-text">3.1.4 核心获取流程：acquire(...)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%8A%A0%E9%94%81%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">1.4.2.</span> <span class="toc-text">3.2 加锁流程图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E8%A7%A3%E9%94%81%E6%B5%81%E7%A8%8B%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.5.</span> <span class="toc-text">4. 解锁流程详解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%AE%8C%E6%95%B4%E8%A7%A3%E9%94%81%E6%B5%81%E7%A8%8B"><span class="toc-number">1.5.1.</span> <span class="toc-text">4.1 完整解锁流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-ReentrantLock-unlock"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">4.1.1 ReentrantLock.unlock()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-AQS-release-int-arg"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">4.1.2 AQS.release(int arg)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-3-tryRelease-arg-%EF%BC%88ReentrantLock-%E7%9A%84%E5%AE%9E%E7%8E%B0%EF%BC%89"><span class="toc-number">1.5.1.3.</span> <span class="toc-text">4.1.3 tryRelease(arg) （ReentrantLock 的实现）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-4-%E5%94%A4%E9%86%92%E5%90%8E%E7%BB%A7%E7%BA%BF%E7%A8%8B%EF%BC%9AunparkSuccessor-Node-h"><span class="toc-number">1.5.1.4.</span> <span class="toc-text">4.1.4 唤醒后继线程：unparkSuccessor(Node h)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E8%A7%A3%E9%94%81%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">1.5.2.</span> <span class="toc-text">4.2 解锁流程图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E5%85%AC%E5%B9%B3%E9%94%81vs%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%81"><span class="toc-number">1.6.</span> <span class="toc-text">5. 公平锁vs非公平锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%AF%B9%E6%AF%94%E6%80%BB%E7%BB%93"><span class="toc-number">1.6.1.</span> <span class="toc-text">5.1 对比总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E6%A0%B8%E5%BF%83%E5%B7%AE%E5%BC%82%E4%BB%A3%E7%A0%81"><span class="toc-number">1.6.2.</span> <span class="toc-text">5.2 核心差异代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E9%80%89%E6%8B%A9%E5%BB%BA%E8%AE%AE"><span class="toc-number">1.6.3.</span> <span class="toc-text">5.3 选择建议</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E7%9B%B8%E5%85%B3%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="toc-number">1.7.</span> <span class="toc-text">6. 相关面试题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-AQS%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86"><span class="toc-number">1.7.1.</span> <span class="toc-text">6.1 AQS核心原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-ReentrantLock%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">1.7.2.</span> <span class="toc-text">6.2 ReentrantLock实现原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E5%85%AC%E5%B9%B3%E9%94%81vs%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%81"><span class="toc-number">1.7.3.</span> <span class="toc-text">6.3 公平锁vs非公平锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-AQS%E9%98%9F%E5%88%97%E6%9C%BA%E5%88%B6"><span class="toc-number">1.7.4.</span> <span class="toc-text">6.4 AQS队列机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-5-%E9%94%81%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96"><span class="toc-number">1.7.5.</span> <span class="toc-text">6.5 锁的性能优化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-6-%E6%AD%BB%E9%94%81%E9%A2%84%E9%98%B2"><span class="toc-number">1.7.6.</span> <span class="toc-text">6.6 死锁预防</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-7-%E6%BA%90%E7%A0%81%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.7.7.</span> <span class="toc-text">6.7 源码设计模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-8-%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.7.8.</span> <span class="toc-text">6.8 实际应用场景</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">1.8.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2025/10/23/%E5%A4%9A%E7%BA%BF%E7%A8%8B_%E8%99%9A%E6%8B%9F%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%BC%8F/" title="Java 虚拟线程模式详解：从原理到实践"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://origin.picgo.net/2025/10/23/1739c9e15974460f19.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Java 虚拟线程模式详解：从原理到实践"/></a><div class="content"><a class="title" href="/2025/10/23/%E5%A4%9A%E7%BA%BF%E7%A8%8B_%E8%99%9A%E6%8B%9F%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%BC%8F/" title="Java 虚拟线程模式详解：从原理到实践">Java 虚拟线程模式详解：从原理到实践</a><time datetime="2025-10-23T10:10:39.474Z" title="Created 2025-10-23 18:10:39">2025-10-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/10/02/AI_MCP/" title="FunctionCall、Agent、Mcp"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://origin.picgo.net/2025/10/23/mcp3bc2d880cef29b025.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="FunctionCall、Agent、Mcp"/></a><div class="content"><a class="title" href="/2025/10/02/AI_MCP/" title="FunctionCall、Agent、Mcp">FunctionCall、Agent、Mcp</a><time datetime="2025-10-02T14:04:39.023Z" title="Created 2025-10-02 22:04:39">2025-10-02</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/26/Redis_List/" title="Redis_List"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://origin.picgo.net/2025/08/07/1eb94f064cf74b04865bdaf1b3c8e9be6939674b9205c975.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Redis_List"/></a><div class="content"><a class="title" href="/2025/09/26/Redis_List/" title="Redis_List">Redis_List</a><time datetime="2025-09-26T06:03:11.297Z" title="Created 2025-09-26 14:03:11">2025-09-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/25/%E7%AE%97%E6%B3%95_%E6%8E%92%E5%BA%8F/" title="算法_常见排序及复杂度比较"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://origin.picgo.net/2025/08/31/data_st36d19cecfce34426.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="算法_常见排序及复杂度比较"/></a><div class="content"><a class="title" href="/2025/09/25/%E7%AE%97%E6%B3%95_%E6%8E%92%E5%BA%8F/" title="算法_常见排序及复杂度比较">算法_常见排序及复杂度比较</a><time datetime="2025-09-25T08:32:37.098Z" title="Created 2025-09-25 16:32:37">2025-09-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/09/25/Spring_Async/" title="Spring Async 异步编程详解"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://origin.picgo.net/2025/09/25/asyncabc674a8cbe370a0.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Spring Async 异步编程详解"/></a><div class="content"><a class="title" href="/2025/09/25/Spring_Async/" title="Spring Async 异步编程详解">Spring Async 异步编程详解</a><time datetime="2025-09-25T02:57:07.010Z" title="Created 2025-09-25 10:57:07">2025-09-25</time></div></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="workboard"><div id="runtimeTextTip"></div></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title="博客框架为Hexo_v5.4.0"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" alt="博客框架为Hexo_v5.4.0"/></a><a class="github-badge" target="_blank" href="https://blog.anheyu.com/" style="margin-inline:5px" data-title="本站使用AnZhiYu主题" title="本站使用AnZhiYu主题"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.9/img/Theme-AnZhiYu-2E67D3.svg" alt="本站使用AnZhiYu主题"/></a></p></div><div id="footer-bar"><div class="footer-bar-links"><div class="footer-bar-left"><div id="footer-bar-tips"><div class="copyright">&copy;2025 By <a class="footer-bar-link" href="/" title="Joie" target="_blank">Joie</a></div></div><div id="footer-type-tips"></div><div class="js-pjax"><script>function subtitleType () {
  fetch('https://v1.hitokoto.cn')
    .then(response => response.json())
    .then(data => {
      if (true) {
        const from = '出自 ' + data.from
        const sub = []
        sub.unshift(data.hitokoto, from)
        window.typed = new Typed('#footer-type-tips', {
          strings: sub,
          startDelay: 300,
          typeSpeed: 150,
          loop: true,
          backSpeed: 50,
        })
      } else {
        document.getElementById('footer-type-tips').innerHTML = data.hitokoto
      }
    })
}

if (true) {
  if (typeof Typed === 'function') {
    subtitleType()
  } else {
    getScript('https://cdn.cbd.int/typed.js@2.1.0/dist/typed.umd.js').then(subtitleType)
  }
} else {
  subtitleType()
}
</script></div></div><div class="footer-bar-right"><a class="footer-bar-link" target="_blank" rel="noopener" href="https://github.com/anzhiyu-c/hexo-theme-anzhiyu" title="主题">主题</a></div></div></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">Articles</div><div class="length-num">93</div></a><a href="/tags/" title="tag"><div class="headline">Tags</div><div class="length-num">41</div></a><a href="/categories/" title="category"><div class="headline">Categories</div><div class="length-num">30</div></a></div><span class="sidebar-menu-item-title">Function</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="Display Mode"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>Display Mode</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">个人主页</div><div class="back-menu-list"><a class="back-menu-item" target="_blank" rel="noopener" href="https://benedicttom.github.io/home/" title="个人主页"><img class="back-menu-item-icon" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror="this.onerror=null,this.src=&quot;/img/404.jpg&quot;" data-lazy-src="/img/favicon.ico" alt="个人主页"/><span class="back-menu-item-text">个人主页</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 友链</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/link/"><i class="anzhiyufont anzhiyu-icon-link faa-tada" style="font-size: 0.9em;"></i><span> 友人帐</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/comments/"><i class="anzhiyufont anzhiyu-icon-envelope faa-tada" style="font-size: 0.9em;"></i><span> 留言板</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/essay/"><i class="anzhiyufont anzhiyu-icon-lightbulb faa-tada" style="font-size: 0.9em;"></i><span> 闲言碎语</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/equipment/"><i class="anzhiyufont anzhiyu-icon-dice-d20 faa-tada" style="font-size: 0.9em;"></i><span> 我的装备</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/AI/" style="font-size: 0.88rem;">AI<sup>1</sup></a><a href="/tags/AMQP/" style="font-size: 0.88rem;">AMQP<sup>1</sup></a><a href="/tags/CI-CD/" style="font-size: 0.88rem;">CI/CD<sup>1</sup></a><a href="/tags/ElasticSearch/" style="font-size: 0.88rem;">ElasticSearch<sup>3</sup></a><a href="/tags/Hexo/" style="font-size: 0.88rem;">Hexo<sup>1</sup></a><a href="/tags/Http/" style="font-size: 0.88rem;">Http<sup>2</sup></a><a href="/tags/I-O/" style="font-size: 0.88rem;">I/O<sup>2</sup></a><a href="/tags/Java/" style="font-size: 0.88rem;">Java<sup>10</sup></a><a href="/tags/MongoDB/" style="font-size: 0.88rem;">MongoDB<sup>1</sup></a><a href="/tags/Mysql/" style="font-size: 0.88rem;">Mysql<sup>2</sup></a><a href="/tags/ORM/" style="font-size: 0.88rem;">ORM<sup>3</sup></a><a href="/tags/Python/" style="font-size: 0.88rem;">Python<sup>5</sup></a><a href="/tags/Redis/" style="font-size: 0.88rem;">Redis<sup>7</sup></a><a href="/tags/Redisson/" style="font-size: 0.88rem;">Redisson<sup>1</sup></a><a href="/tags/Rpc/" style="font-size: 0.88rem;">Rpc<sup>2</sup></a><a href="/tags/Spring/" style="font-size: 0.88rem;">Spring<sup>3</sup></a><a href="/tags/Spring-Cloud/" style="font-size: 0.88rem;">Spring Cloud<sup>5</sup></a><a href="/tags/Spring-Data/" style="font-size: 0.88rem;">Spring Data<sup>5</sup></a><a href="/tags/Swagger/" style="font-size: 0.88rem;">Swagger<sup>1</sup></a><a href="/tags/%E4%B8%9A%E5%8A%A1/" style="font-size: 0.88rem;">业务<sup>1</sup></a><a href="/tags/%E4%BA%91%E5%8E%9F%E7%94%9F/" style="font-size: 0.88rem;">云原生<sup>1</sup></a><a href="/tags/%E5%85%AB%E8%82%A1/" style="font-size: 0.88rem;">八股<sup>1</sup></a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" style="font-size: 0.88rem;">分布式锁<sup>1</sup></a><a href="/tags/%E5%8A%9B%E6%89%A3/" style="font-size: 0.88rem;">力扣<sup>10</sup></a><a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 0.88rem;">多线程<sup>9</sup></a><a href="/tags/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/" style="font-size: 0.88rem;">定时任务<sup>3</sup></a><a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 0.88rem;">并发<sup>10</sup></a><a href="/tags/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" style="font-size: 0.88rem;">开发工具<sup>2</sup></a><a href="/tags/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B/" style="font-size: 0.88rem;">异步编程<sup>1</sup></a><a href="/tags/%E6%8E%A8%E8%8D%90/" style="font-size: 0.88rem;">推荐<sup>1</sup></a><a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 0.88rem;">数据结构<sup>1</sup></a><a href="/tags/%E6%9D%83%E9%99%90%E6%A0%A1%E9%AA%8C/" style="font-size: 0.88rem;">权限校验<sup>4</sup></a><a href="/tags/%E6%9E%B6%E6%9E%84/" style="font-size: 0.88rem;">架构<sup>1</sup></a><a href="/tags/%E6%A0%91/" style="font-size: 0.88rem;">树<sup>1</sup></a><a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 0.88rem;">消息队列<sup>5</sup></a><a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 0.88rem;">算法<sup>2</sup></a><a href="/tags/%E7%BC%93%E5%AD%98/" style="font-size: 0.88rem;">缓存<sup>3</sup></a><a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 0.88rem;">设计模式<sup>1</sup></a><a href="/tags/%E8%BF%90%E7%BB%B4/" style="font-size: 0.88rem;">运维<sup>2</sup></a><a href="/tags/%E9%9B%86%E5%90%88/" style="font-size: 0.88rem;">集合<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Setting"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="8152976493" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://y.qq.com/n/ryqq/playlist/8802438608&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/vanilla-lazyload@17.8.5/dist/lazyload.iife.min.js"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2025 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2025 By 安知鱼 V1.6.14",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 Joie 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script async="async">(function () {
  var grt = new Date("04/01/2025 00:00:00"); //设置网站上线时间
  var now = new Date();
  var dnum;
  var hnum;
  var mnum;
  var snum;
  var nowHour;

  // 计算并更新天数、小时数、分钟数和秒数
  function updateTime() {
    now = new Date(); // 更新 now 的值
    nowHour = now.getHours(); // 更新 nowHour 的值
    var days = (now - grt) / 1000 / 60 / 60 / 24;
    dnum = Math.floor(days);
    var hours = (now - grt) / 1000 / 60 / 60 - 24 * dnum;
    hnum = Math.floor(hours);
    if (String(hnum).length == 1) {
      hnum = "0" + hnum;
    }
    var minutes = (now - grt) / 1000 / 60 - 24 * 60 * dnum - 60 * hnum;
    mnum = Math.floor(minutes);
    if (String(mnum).length == 1) {
      mnum = "0" + mnum;
    }
    var seconds = (now - grt) / 1000 - 24 * 60 * 60 * dnum - 60 * 60 * hnum - 60 * mnum;
    snum = Math.round(seconds);
    if (String(snum).length == 1) {
      snum = "0" + snum;
    }
  }

  // 更新网页中显示的网站运行时间
  function updateHtml() {
    const footer = document.getElementById("footer");
    if (!footer) return
    let currentTimeHtml = "";
    if (nowHour < 18 && nowHour >= 9) {
      // 如果是上班时间，默认就是"安知鱼-上班摸鱼中.svg"图片，不需要更改
      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    } else {
      // 如果是下班时间，插入"安知鱼-下班啦.svg"图片
      let img = document.querySelector("#workboard .workSituationImg");
      if (img != null) {
        img.src = "";
        img.title = "";
        img.alt = "";
      }

      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    }

    if (document.getElementById("runtimeTextTip")) {
      document.getElementById("runtimeTextTip").innerHTML = currentTimeHtml;
    }
  }

  setInterval(() => {
    updateTime();
    updateHtml();
  }, 1000);
})();</script><div class="js-pjax"><input type="hidden" name="page-type" id="page-type" value="post"></div><script>var visitorMail = "";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div></body></html>